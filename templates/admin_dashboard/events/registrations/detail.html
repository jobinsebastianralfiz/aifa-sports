{% extends 'admin_dashboard/base.html' %}
{% load event_filters %}

{% block page_title %}Registration #{{ registration.id }} - {{ event.title }}{% endblock %}
{% block header_title %}{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="content-header">
    <div class="content-header-left">
        <h2>Registration Details</h2>
        <p class="text-muted">{{ event.title }} - Registration #{{ registration.id }}</p>
    </div>
    <div class="content-header-right">
        <a href="{% url 'admin_dashboard:events:registrations' event.pk %}" class="btn btn-ghost">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="19" y1="12" x2="5" y2="12"/>
                <polyline points="12 19 5 12 12 5"/>
            </svg>
            Back to Registrations
        </a>
    </div>
</div>

<div class="detail-grid">
    <!-- Main Content -->
    <div class="detail-main">
        <!-- Registration Info -->
        <div class="detail-card">
            <div class="detail-card-header">
                <h3>Registration Information</h3>
                <span class="badge {% if registration.status == 'confirmed' %}badge-success{% elif registration.status == 'pending' %}badge-warning{% elif registration.status == 'cancelled' %}badge-danger{% else %}badge-secondary{% endif %}">
                    {{ registration.get_status_display }}
                </span>
            </div>

            <div class="detail-info-grid">
                <div class="detail-info-item">
                    <span class="detail-label">Registration ID</span>
                    <span class="detail-value">#{{ registration.id }}</span>
                </div>
                <div class="detail-info-item">
                    <span class="detail-label">Registered At</span>
                    <span class="detail-value">{{ registration.created_at|date:"F d, Y \a\t H:i" }}</span>
                </div>
                {% if registration.updated_at %}
                <div class="detail-info-item">
                    <span class="detail-label">Last Updated</span>
                    <span class="detail-value">{{ registration.updated_at|date:"F d, Y \a\t H:i" }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Form Data -->
        <div class="detail-card">
            <div class="detail-card-header">
                <h3>Submitted Form Data</h3>
            </div>

            <div class="form-data-list">
                {% for field in form_fields %}
                <div class="form-data-item">
                    <div class="form-data-label">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                            {% if field.field_type == 'email' %}
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                            {% elif field.field_type == 'phone' %}
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                            {% elif field.field_type == 'date' %}
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                            {% elif field.field_type == 'number' %}
                            <line x1="4" y1="9" x2="20" y2="9"/>
                            <line x1="4" y1="15" x2="20" y2="15"/>
                            <line x1="10" y1="3" x2="8" y2="21"/>
                            <line x1="16" y1="3" x2="14" y2="21"/>
                            {% elif field.field_type == 'textarea' %}
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <path d="M14 2v6h6"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                            {% elif field.field_type == 'select' %}
                            <path d="M6 9l6 6 6-6"/>
                            {% elif field.field_type == 'checkbox' %}
                            <polyline points="9 11 12 14 22 4"/>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                            {% else %}
                            <line x1="4" y1="21" x2="4" y2="14"/>
                            <line x1="4" y1="10" x2="4" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="12"/>
                            <line x1="12" y1="8" x2="12" y2="3"/>
                            <line x1="20" y1="21" x2="20" y2="16"/>
                            <line x1="20" y1="12" x2="20" y2="3"/>
                            {% endif %}
                        </svg>
                        {{ field.label }}
                        {% if field.is_required %}<span class="required">*</span>{% endif %}
                    </div>
                    <div class="form-data-value">
                        {% with value=registration.form_data|get_item:field.field_name %}
                        {% if value %}
                            {% if field.field_type == 'checkbox' %}
                                {% if value %}
                                <span class="badge badge-success">Yes</span>
                                {% else %}
                                <span class="badge badge-secondary">No</span>
                                {% endif %}
                            {% elif field.field_type == 'email' %}
                                <a href="mailto:{{ value }}">{{ value }}</a>
                            {% elif field.field_type == 'phone' %}
                                <a href="tel:{{ value }}">{{ value }}</a>
                            {% else %}
                                {{ value }}
                            {% endif %}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                        {% endwith %}
                    </div>
                </div>
                {% empty %}
                <div class="empty-state-small">
                    <p>No form fields defined for this event.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="detail-sidebar">
        <!-- Event Info -->
        <div class="detail-card">
            <h3 class="detail-card-title">Event Details</h3>

            {% if event.featured_image %}
            <div class="detail-event-image">
                <img src="{{ event.featured_image.url }}" alt="{{ event.title }}">
            </div>
            {% endif %}

            <div class="detail-event-info">
                <h4>{{ event.title }}</h4>
                <p class="text-muted">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    {{ event.start_date|date:"M d, Y" }}
                </p>
                <p class="text-muted">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                    {{ event.venue }}
                </p>
            </div>

            <a href="{% url 'admin_dashboard:events:update' event.pk %}" class="btn btn-outline btn-block">
                View Event
            </a>
        </div>

        <!-- Status Actions -->
        <div class="detail-card">
            <h3 class="detail-card-title">Update Status</h3>

            <form method="post" action="{% url 'admin_dashboard:events:registration-status' registration.pk %}">
                {% csrf_token %}
                <div class="form-group">
                    <select name="status" class="form-control">
                        <option value="pending" {% if registration.status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="confirmed" {% if registration.status == 'confirmed' %}selected{% endif %}>Confirmed</option>
                        <option value="cancelled" {% if registration.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary btn-block">Update Status</button>
            </form>
        </div>

        <!-- Danger Zone -->
        <div class="detail-card danger-zone">
            <h3 class="detail-card-title text-danger">Danger Zone</h3>
            <p class="text-muted">Permanently delete this registration.</p>
            <a href="{% url 'admin_dashboard:events:registration-delete' registration.pk %}" class="btn btn-outline-danger btn-block">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                Delete Registration
            </a>
        </div>
    </div>
</div>

<style>
.detail-grid {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 1.5rem;
}

.detail-main {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.detail-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.detail-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
}

.detail-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.detail-card-header h3 {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0;
}

.detail-card-title {
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 1rem 0;
}

.detail-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
}

.detail-info-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.detail-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.detail-value {
    font-size: 1rem;
    font-weight: 500;
    color: var(--text-color);
}

.form-data-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.form-data-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 1rem;
    background: var(--bg-color);
    border-radius: 8px;
}

.form-data-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-muted);
}

.form-data-label svg {
    opacity: 0.6;
}

.form-data-value {
    font-size: 1rem;
    color: var(--text-color);
    padding-left: 1.5rem;
}

.form-data-value a {
    color: var(--primary);
    text-decoration: none;
}

.form-data-value a:hover {
    text-decoration: underline;
}

.detail-event-image {
    margin-bottom: 1rem;
    border-radius: 8px;
    overflow: hidden;
}

.detail-event-image img {
    width: 100%;
    height: 150px;
    object-fit: cover;
}

.detail-event-info {
    margin-bottom: 1rem;
}

.detail-event-info h4 {
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
}

.detail-event-info p {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    margin: 0.25rem 0;
}

.danger-zone {
    border-color: var(--danger);
}

.empty-state-small {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
}

.required {
    color: var(--danger);
}

@media (max-width: 1024px) {
    .detail-grid {
        grid-template-columns: 1fr;
    }

    .detail-sidebar {
        order: -1;
    }
}
</style>
{% endblock %}
